<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ“ç„ä¸‰ä¸­çˆ¬èŸ²é£¼é¤Šæ—¥èªŒ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Custom Styles and Tailwind Config -->
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .font-brand {
            font-family: 'Noto Sans TC', sans-serif;
        }
        /* Custom styles for date picker icon */
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            opacity: 0.6;
            filter: invert(0.5);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                        brand: ['Noto Sans TC', 'sans-serif'],
                    },
                },
            },
        }
    </script>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- Main Container -->
    <div id="app-container" class="min-h-screen">

        <!-- Login Screen -->
        <div id="login-screen" class="flex items-center justify-center min-h-screen p-4">
            <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg">
                <h1 class="text-3xl font-bold text-center text-teal-600 font-brand">åœ“ç„ä¸‰ä¸­çˆ¬èŸ²é£¼é¤Šæ—¥èªŒ</h1>
                <p class="text-center text-slate-500 mt-2 mb-6">è«‹ç™»å…¥ä»¥ç¹¼çºŒ</p>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="username" class="block text-sm font-medium text-slate-600 mb-1">ä½¿ç”¨è€…å¸³è™Ÿ</label>
                        <input type="text" id="username" name="username" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-slate-600 mb-1">å¯†ç¢¼</label>
                        <input type="password" id="password" name="password" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" required>
                    </div>
                    <button type="submit" class="w-full bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 transition-colors duration-300">
                        ç™»å…¥
                    </button>
                    <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
                </form>
            </div>
        </div>

        <!-- App Screen (Hidden by default) -->
        <div id="app-screen" class="hidden">
            <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
                <h1 class="text-2xl font-bold text-teal-600 font-brand">é£¼é¤Šæ—¥èªŒå„€è¡¨æ¿</h1>
                 <div>
                    <span id="welcome-user" class="text-slate-600 mr-4"></span>
                    <button id="logout-btn" class="bg-slate-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-600 transition-colors">
                        ç™»å‡º
                    </button>
                 </div>
            </header>

            <main class="p-4 md:p-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column: Log Form -->
                <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg self-start">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2">æ–°å¢æ¯æ—¥è¨˜éŒ„</h2>
                    <form id="log-form" class="space-y-4">
                        <div>
                            <label for="recordDate" class="block text-sm font-medium text-slate-600">è¨˜éŒ„æ—¥æœŸ</label>
                            <input type="date" id="recordDate" name="recordDate" class="mt-1 w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" required>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="recorder" class="block text-sm font-medium text-slate-600">è¨˜éŒ„äºº</label>
                                <select id="recorder" name="recorder" class="mt-1 w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" required>
                                    <option value="" disabled selected>è«‹é¸æ“‡...</option>
                                </select>
                            </div>
                            <div>
                                <label for="reptileName" class="block text-sm font-medium text-slate-600">çˆ¬èŸ²åç¨±</label>
                                <select id="reptileName" name="reptileName" class="mt-1 w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" required>
                                     <option value="" disabled selected>è«‹é¸æ“‡...</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="temperature" class="block text-sm font-medium text-slate-600">æº«åº¦ (Â°C)</label>
                                <input type="number" step="0.1" id="temperature" name="temperature" class="mt-1 w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                            </div>
                            <div>
                                <label for="humidity" class="block text-sm font-medium text-slate-600">æ¿•åº¦ (%)</label>
                                <input type="number" step="1" id="humidity" name="humidity" class="mt-1 w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                            </div>
                        </div>
                         <fieldset class="border rounded-lg p-3">
                            <legend class="text-sm font-medium text-slate-600 px-1">é¤µé£Ÿè¨˜éŒ„</legend>
                            <div class="grid grid-cols-3 gap-2 items-center">
                                <div class="col-span-1">
                                    <label for="fed" class="block text-xs font-medium text-slate-600">æ˜¯å¦é¤µé£Ÿ</label>
                                    <select id="fed" name="fed" class="mt-1 w-full px-2 py-2 border border-slate-300 rounded-lg text-sm">
                                        <option value="å¦" selected>å¦</option>
                                        <option value="æ˜¯">æ˜¯</option>
                                    </select>
                                </div>
                                <div class="col-span-1">
                                    <label for="foodType" class="block text-xs font-medium text-slate-600">é£Ÿç‰©ç¨®é¡</label>
                                    <input type="text" id="foodType" name="foodType" class="mt-1 w-full px-2 py-2 border border-slate-300 rounded-lg text-sm" disabled>
                                </div>
                                <div class="col-span-1">
                                    <label for="foodAmount" class="block text-xs font-medium text-slate-600">æ•¸é‡</label>
                                    <input type="number" id="foodAmount" name="foodAmount" min="0" class="mt-1 w-full px-2 py-2 border border-slate-300 rounded-lg text-sm" disabled>
                                </div>
                            </div>
                        </fieldset>
                        <div>
                           <label for="watered" class="block text-sm font-medium text-slate-600">é£²æ°´è¨˜éŒ„</label>
                           <select id="watered" name="watered" class="mt-1 w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                                <option value="å¦" selected>å¦</option>
                                <option value="æ˜¯">æ˜¯ (å·²æ›´æ›)</option>
                           </select>
                        </div>
                        <div>
                             <label for="notes" class="block text-sm font-medium text-slate-600">å‚™è¨»</label>
                             <textarea id="notes" name="notes" rows="3" class="mt-1 w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" placeholder="è¨˜éŒ„çˆ¬èŸ²çš„æ´»å‹•ç‹€æ³ã€æ’ä¾¿ã€è›»çš®ç­‰..."></textarea>
                        </div>
                        <div>
                             <label for="media-upload" class="block text-sm font-medium text-slate-600">ä¸Šå‚³ç…§ç‰‡/å½±ç‰‡</label>
                             <input type="file" id="media-upload" name="media-upload" class="mt-1 w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100">
                             <p class="text-xs text-slate-400 mt-1">æª”æ¡ˆå°‡ä¾çˆ¬èŸ²åç¨±æ­¸æª”ä¸¦é‡æ–°å‘½å</p>
                        </div>
                        <button type="submit" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition-colors text-base">
                            æäº¤ç´€éŒ„
                        </button>
                    </form>
                </div>

                <!-- Right Column: Data Visualization & Logs -->
                <div class="lg:col-span-2 space-y-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-bold mb-4">æ•¸æ“šçµ±è¨ˆï¼šæ¯éš»çˆ¬èŸ²ç¸½é¤µé£Ÿæ¬¡æ•¸</h2>
                        <div class="h-64">
                             <canvas id="feeding-chart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-bold mb-4">æœ€è¿‘çš„ç´€éŒ„</h2>
                        <div id="logs-container" class="max-h-[40rem] overflow-y-auto space-y-4 pr-2">
                           <p id="no-logs-msg" class="text-slate-500">æ­£åœ¨è¼‰å…¥ç´€éŒ„æˆ–æš«ç„¡ç´€éŒ„...</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
        
        <!-- Loading Spinner Overlay -->
        <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-teal-500"></div>
            <p class="text-white ml-4 text-lg">è™•ç†ä¸­...</p>
        </div>

        <!-- Toast Notification -->
        <div id="toast" class="hidden fixed bottom-5 right-5 bg-green-600 text-white py-2 px-5 rounded-lg shadow-xl transition-opacity duration-300 z-50">
             <p id="toast-message"></p>
        </div>

    </div>

    <script>
        // --- CONFIGURATION ---
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbysXpH6yO9aU38R07DTncy6yN3wvycNXfJRgPdyYPhFbM2aTu4Rx25FOZtx_noGKZydQQ/exec'; // !!! IMPORTANT: REPLACE THIS !!!

        // --- DOM Elements ---
        const loginScreen = document.getElementById('login-screen');
        const appScreen = document.getElementById('app-screen');
        const loginForm = document.getElementById('login-form');
        const logForm = document.getElementById('log-form');
        const logoutBtn = document.getElementById('logout-btn');
        const loginError = document.getElementById('login-error');
        const loadingOverlay = document.getElementById('loading-overlay');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const logsContainer = document.getElementById('logs-container');
        const noLogsMsg = document.getElementById('no-logs-msg');
        const chartCanvas = document.getElementById('feeding-chart').getContext('2d');
        const welcomeUserEl = document.getElementById('welcome-user');
        
        let feedingChart;
        let currentUser = null;

        // --- Functions ---
        
        function showToast(message, isError = false) {
            toastMessage.innerText = message;
            toast.className = toast.className.replace(/bg-\w+-\d+/, isError ? 'bg-red-600' : 'bg-green-600');
            toast.classList.remove('hidden');
            setTimeout(() => { toast.classList.add('hidden'); }, 3000);
        }

        function toggleLoader(show) {
            loadingOverlay.classList.toggle('hidden', !show);
        }

        function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const encoded = reader.result.toString().replace(/^data:(.*,)?/, '');
                    if ((encoded.length % 4) > 0) {
                       encoded += '='.repeat(4 - (encoded.length % 4));
                    }
                    resolve({ base64: encoded, type: file.type, name: file.name });
                };
                reader.onerror = error => reject(error);
            });
        }
        
        async function initializeApp() {
            toggleLoader(true);
            try {
                // Fetch initial data for dropdowns and all logs in parallel
                const [initialDataRes, logsRes] = await Promise.all([
                    fetch(GAS_WEB_APP_URL + '?action=getInitialData'),
                    fetch(GAS_WEB_APP_URL + '?action=getLogs')
                ]);

                if (!initialDataRes.ok || !logsRes.ok) throw new Error('Failed to fetch initial data.');

                const initialData = await initialDataRes.json();
                const logsData = await logsRes.json();

                if (initialData.success) {
                    populateDropdowns(initialData.data);
                }

                if (logsData.success) {
                    renderLogs(logsData.logs);
                    renderChart(logsData.logs);
                } else {
                    renderChart([]); // Render empty chart if no logs
                }
                
                noLogsMsg.classList.toggle('hidden', logsData.logs.length > 0);

            } catch (error) {
                console.error("Initialization error:", error);
                showToast("ç„¡æ³•è¼‰å…¥åˆå§‹è³‡æ–™", true);
                noLogsMsg.textContent = "è¼‰å…¥è³‡æ–™å¤±æ•—ã€‚";
            } finally {
                toggleLoader(false);
            }
        }

        function populateDropdowns(data) {
            const recorderSelect = document.getElementById('recorder');
            const reptileSelect = document.getElementById('reptileName');
            
            data.recorders.forEach(name => {
                const option = new Option(name, name);
                recorderSelect.add(option);
            });

            data.reptiles.forEach(name => {
                const option = new Option(name, name);
                reptileSelect.add(option);
            });
        }
        
        function renderLogs(logs) {
            logsContainer.innerHTML = '';
            if (logs.length === 0) return;
            
            logs.slice().reverse().forEach(log => {
                const logElement = document.createElement('div');
                logElement.className = 'p-4 border rounded-lg bg-slate-50 text-sm';
                
                let mediaLink = log.mediaUrl ? `<a href="${log.mediaUrl}" target="_blank" class="text-teal-600 hover:underline">æŸ¥çœ‹é™„ä»¶</a>` : '';
                
                logElement.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <p class="font-bold text-slate-700 text-base">${log.reptileName} - ${log.recordDate}</p>
                        <span class="text-xs text-slate-500">è¨˜éŒ„äºº: ${log.recorder}</span>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-slate-600">
                        <span>ğŸŒ¡ï¸ æº«åº¦: ${log.temperature || 'N/A'}Â°C</span>
                        <span>ğŸ’§ æ¿•åº¦: ${log.humidity || 'N/A'}%</span>
                        <span>ğŸ¦— é¤µé£Ÿ: ${log.fed}</span>
                        <span>ğŸ¥› æ›æ°´: ${log.watered}</span>
                    </div>
                    ${log.fed === 'æ˜¯' ? `<p class="text-slate-600 mt-2">é£Ÿç‰©: ${log.foodType || ''} (æ•¸é‡: ${log.foodAmount || 'N/A'})</p>` : ''}
                    <p class="text-slate-500 mt-2"><strong class="font-medium text-slate-600">å‚™è¨»:</strong> ${log.notes || 'ç„¡'}</p>
                    ${mediaLink && `<div class="mt-2">${mediaLink}</div>`}
                `;
                logsContainer.appendChild(logElement);
            });
        }
        
        function renderChart(logs) {
            const feedingCounts = logs.reduce((acc, log) => {
                if (log.fed === 'æ˜¯') {
                    acc[log.reptileName] = (acc[log.reptileName] || 0) + 1;
                }
                return acc;
            }, {});

            const reptileNames = Object.keys(feedingCounts);
            const counts = Object.values(feedingCounts);
            
            const chartData = {
                labels: reptileNames,
                datasets: [{
                    label: 'ç¸½é¤µé£Ÿæ¬¡æ•¸',
                    data: counts,
                    backgroundColor: 'rgba(13, 148, 136, 0.6)',
                    borderColor: 'rgba(13, 148, 136, 1)',
                    borderWidth: 1,
                    borderRadius: 5,
                }]
            };

            if (feedingChart) {
                feedingChart.data = chartData;
                feedingChart.update();
            } else {
                 feedingChart = new Chart(chartCanvas, {
                    type: 'bar',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                        plugins: { legend: { display: true } }
                    }
                });
            }
        }
        
        // --- Event Listeners & Initializers ---
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleLoader(true);
            loginError.textContent = '';
            
            if (GAS_WEB_APP_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL') {
                showToast("è«‹å…ˆåœ¨ JS ä¸­è¨­å®šæ‚¨çš„ GAS Web App URL", true);
                toggleLoader(false);
                return;
            }

            const formData = new FormData(loginForm);
            currentUser = formData.get('username'); // Store username
            const data = { action: 'login', ...Object.fromEntries(formData.entries()) };

            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if (result.success) {
                    loginScreen.classList.add('hidden');
                    appScreen.classList.remove('hidden');
                    welcomeUserEl.textContent = `æ­¡è¿, ${currentUser}`;
                    await initializeApp();
                } else {
                    loginError.textContent = result.message || 'ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼ã€‚';
                }
            } catch (error) {
                console.error("Login error:", error);
                loginError.textContent = 'ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
            } finally {
                toggleLoader(false);
            }
        });

        logoutBtn.addEventListener('click', () => {
            appScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            document.getElementById('password').value = '';
            loginError.textContent = '';
            currentUser = null;
        });

        logForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleLoader(true);

            const formData = new FormData(logForm);
            const data = { action: 'addLog', ...Object.fromEntries(formData.entries()) };
            
            const fileInput = document.getElementById('media-upload');
            if (fileInput.files.length > 0) {
                try {
                    data.file = await getBase64(fileInput.files[0]);
                } catch (error) {
                     showToast("è®€å–æª”æ¡ˆå¤±æ•—", true);
                     toggleLoader(false);
                     return;
                }
            }
            
            try {
                 const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (result.success) {
                    showToast("ç´€éŒ„å·²æˆåŠŸæ–°å¢ï¼");
                    logForm.reset();
                    document.getElementById('recordDate').value = new Date().toISOString().split('T')[0]; // Reset date to today
                    document.getElementById('foodType').disabled = true;
                    document.getElementById('foodAmount').disabled = true;
                    await initializeApp(); // Refresh all data
                } else {
                    showToast(result.message || "æ–°å¢ç´€éŒ„å¤±æ•—", true);
                }
            } catch (error) {
                showToast("æäº¤å¤±æ•—ï¼Œç™¼ç”Ÿç¶²è·¯éŒ¯èª¤", true);
            } finally {
                toggleLoader(false);
            }
        });
        
        // Enable/disable food inputs based on 'fed' dropdown
        document.getElementById('fed').addEventListener('change', (e) => {
            const disabled = e.target.value === 'å¦';
            document.getElementById('foodType').disabled = disabled;
            document.getElementById('foodAmount').disabled = disabled;
            if (disabled) {
                document.getElementById('foodType').value = '';
                document.getElementById('foodAmount').value = '';
            }
        });

        // Set default date to today
        document.getElementById('recordDate').value = new Date().toISOString().split('T')[0];

    </script>
</body>
</html>

